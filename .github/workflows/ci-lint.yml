name: Bash CI Linting

# 1. Trigger the workflow on push or pull request events to the main branch
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  # Allow manual triggering of the workflow
  workflow_dispatch:

# 2. Use a job that runs on a GitHub-hosted Ubuntu runner
jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      # 2.1 Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2.2 Find all .sh-files
      # We use find to locate all .sh files and pass them to ShellCheck
      - name: Find Bash scripts
        id: files
        run: |
          # Find all .sh files, exclude those in .github directory
          FILES=$(find . -type f -name "*.sh" ! -path "./.github/*")

          # Log the found files (for debugging purposes)
          echo "--- Found .sh-files: ---"

          if [ -z "$FILES" ]; then
            echo "No .sh-files found."
          else
            echo "$FILES"
          fi

          echo "------------------------"

          # Create a GitHub Actions output variable
          echo "scripts=${FILES}" >> $GITHUB_OUTPUT
      
      # 2.3 Run ShellCheck on the found files
      - name: Run ShellCheck
        uses: reviewdog/action-shellcheck@v1
        with:
          # Using list with files from previous step
          github_token: ${{ secrets.GITHUB_TOKEN }}
          path: ${{ steps.files.outputs.scripts }}
          # Set the level of warnings that should be seen as errors
          fail_level: warning
          # Exclude specific ShellCheck codes if needed (like SC2086)
          # exclude: SC2086

          # Set the format for ShellCheck to "GitHub Actions Log Format"
          reporter: github-pr-check
          # Add a flag to indicate approval

      # 2.4 Add a conformation step if no issues were found (Runs only if ShellCheck passes)
      - name: Linting Passed
        run: | 
          echo "All .sh-scripts passed ShellCheck linting!"
